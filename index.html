<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Coins | Ø§Ù„ÙƒØ§Ù…Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

    <style>
        :root { --gold: #ffcc00; --bg: #050a18; --card-bg: rgba(255, 255, 255, 0.05); }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: white; line-height: 1.6; }
        .container { max-width: 450px; margin: auto; padding: 20px; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ±ÙˆØª */
        .card { background: var(--card-bg); border-radius: 25px; padding: 20px; border: 1px solid rgba(255,204,0,0.1); margin-bottom: 20px; }
        input, select { background: rgba(255,255,255,0.08); border: 1px solid #333; color: white; padding: 12px; border-radius: 12px; width: 100%; box-sizing: border-box; margin-bottom: 12px; text-align: center; }
        .btn-gold { background: var(--gold); color: var(--bg); border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; transition: 0.3s; }
        .btn-gold:hover { background: #e6b800; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        #login-screen, #setup-screen, #main-dashboard { display: none; }
        
        /* Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù€ ID */
        .avatar { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--gold); object-fit: cover; cursor: pointer; }
        .user-id-badge { display: inline-block; background: #000; color: var(--gold); padding: 5px 15px; border-radius: 10px; font-family: monospace; font-size: 0.9rem; margin-top: 10px; }

        /* Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
        .log-list { max-height: 200px; overflow-y: auto; text-align: right; }
        .log-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem; }
        .in { color: #28a745; } .out { color: #ff4444; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="login-screen" style="text-align: center; padding-top: 50px;">
        <img src="Atlas.png" style="width: 120px; margin-bottom: 20px;">
        <h1 style="color: var(--gold);">ATLAS COINS</h1>
        <p>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹</p>
        <button class="btn-gold" onclick="login()">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„</button>
    </div>

    <div id="setup-screen">
        <div class="card" style="text-align: center;">
            <h3>Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <div onclick="document.getElementById('file-input').click()">
                <img id="setup-preview" class="avatar" src="https://via.placeholder.com/90">
                <p style="font-size: 0.7rem; color: var(--gold);">Ø§Ø¶ØºØ· Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</p>
            </div>
            <input type="file" id="file-input" hidden accept="image/*" onchange="previewImg(this)">
            <input type="text" id="full-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <div style="display: flex; gap: 5px;">
                <input type="number" id="b-day" placeholder="ÙŠÙˆÙ…">
                <input type="number" id="b-month" placeholder="Ø´Ù‡Ø±">
                <input type="number" id="b-year" placeholder="Ø³Ù†Ø©">
            </div>
            <input type="text" id="custom-id" placeholder="Ø§Ø®ØªØ± ID Ø®Ø§Øµ Ø¨Ùƒ (Ù…Ø«Ù„Ø§Ù‹: 777-888)">
            <button class="btn-gold" onclick="saveProfile()">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø¨Ù€ 1000 Ø¹Ù…Ù„Ø©</button>
        </div>
    </div>

    <div id="main-dashboard">
        <div class="card" style="text-align: center;">
            <img id="dash-avatar" class="avatar">
            <h2 id="dash-name" style="margin: 10px 0;"></h2>
            <div id="dash-id" class="user-id-badge"></div>
            <div style="margin-top: 20px;">
                <span style="font-size: 0.8rem; color: #888;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                <div style="font-size: 2.5rem; font-weight: bold;"><span id="dash-balance">0</span> AC</div>
            </div>
        </div>

        <div class="card">
            <h4 style="margin: 0 0 10px 0; color: var(--gold);">ğŸ” Ø¨Ø­Ø« ÙˆØªØ­ÙˆÙŠÙ„</h4>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="search-id" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø´Ø®Øµ" style="margin:0;">
                <button onclick="searchUser()" class="btn-gold" style="width: 70px; padding: 10px;">Ø¨Ø­Ø«</button>
            </div>
            <div id="search-result" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <img id="res-img" style="width: 45px; height: 45px; border-radius: 50%;">
                    <span id="res-name" style="font-weight: bold;"></span>
                </div>
                <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø±Ø³Ø§Ù„Ù‡">
                <button onclick="sendCoins()" class="btn-gold" style="background:#28a745; color:white;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>

        <div class="card">
            <h4 style="margin-top: 0;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
            <div id="log-list" class="log-list"></div>
        </div>

        <button onclick="logout()" style="background:none; border:none; color:#ff4444; cursor:pointer; width:100%;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

</div>

<script>
    // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Config) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBQY8BgFSc4ZCQMFx-RAuFF_5osA5gzwJs",
        authDomain: "atlas-b7490.firebaseapp.com",
        projectId: "atlas-b7490",
        storageBucket: "atlas-b7490.firebasestorage.app",
        messagingSenderId: "460412683902",
        appId: "1:460412683902:web:9e91fb6864aee0527c3a2f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ 'client_id': '622781570163-qh2h251eouj3orakpoj15tgma9njo3a9.apps.googleusercontent.com' });

    let myData = null;
    let targetDocId = null;
    let base64Photo = "";

    // --- 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    function login() {
        auth.signInWithPopup(provider).then(res => handleAuth(res.user));
    }

    async function handleAuth(user) {
        const doc = await db.collection("users").doc(user.uid).get();
        if (doc.exists) {
            startDashboard(doc.data(), user.uid);
        } else {
            showSetup(user);
        }
    }

    function showSetup(user) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'block';
        document.getElementById('full-name').value = user.displayName;
        document.getElementById('setup-preview').src = user.photoURL;
        base64Photo = user.photoURL;
    }

    // --- 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---
    function previewImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                base64Photo = e.target.result;
                document.getElementById('setup-preview').src = base64Photo;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveProfile() {
        const atlasId = document.getElementById('custom-id').value;
        const name = document.getElementById('full-name').value;
        const bday = `${document.getElementById('b-day').value}/${document.getElementById('b-month').value}/${document.getElementById('b-year').value}`;
        
        if(!atlasId || !name) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

        const newUser = {
            name: name,
            atlasId: atlasId,
            photo: base64Photo,
            birthday: bday,
            balance: 1000,
            uid: auth.currentUser.uid
        };

        await db.collection("users").doc(newUser.uid).set(newUser);
        startDashboard(newUser, newUser.uid);
    }

    // --- 4. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ ---
    function startDashboard(data, uid) {
        myData = {...data, uid: uid};
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('main-dashboard').style.display = 'block';

        document.getElementById('dash-name').innerText = myData.name;
        document.getElementById('dash-avatar').src = myData.photo;
        document.getElementById('dash-id').innerText = "ID: " + myData.atlasId;
        document.getElementById('dash-balance').innerText = myData.balance.toLocaleString();
        getLogs();
    }

    async function searchUser() {
        const sid = document.getElementById('search-id').value;
        const snap = await db.collection("users").where("atlasId", "==", sid).get();
        if (snap.empty) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø®Øµ!");
        
        const user = snap.docs[0].data();
        targetDocId = snap.docs[0].id;
        document.getElementById('res-name').innerText = user.name;
        document.getElementById('res-img').src = user.photo;
        document.getElementById('search-result').style.display = 'block';
    }

    async function sendCoins() {
        const val = parseInt(document.getElementById('amount').value);
        if (val > myData.balance || val <= 0) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ!");

        const batch = db.batch();
        batch.update(db.collection("users").doc(myData.uid), { balance: firebase.firestore.FieldValue.increment(-val) });
        batch.update(db.collection("users").doc(targetDocId), { balance: firebase.firestore.FieldValue.increment(val) });
        batch.set(db.collection("transactions").doc(), {
            fromId: myData.atlasId, fromName: myData.name,
            toId: document.getElementById('search-id').value, toName: document.getElementById('res-name').innerText,
            amount: val, date: new Date()
        });

        await batch.commit();
        alert("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„!");
        location.reload();
    }

    async function getLogs() {
        const q1 = await db.collection("transactions").where("fromId", "==", myData.atlasId).get();
        const q2 = await db.collection("transactions").where("toId", "==", myData.atlasId).get();
        let logs = [];
        q1.forEach(d => logs.push({...d.data(), type: 'out'}));
        q2.forEach(d => logs.push({...d.data(), type: 'in'}));
        logs.sort((a,b) => b.date - a.date);
        
        document.getElementById('log-list').innerHTML = logs.map(l => `
            <div class="log-item">
                <span>${l.type=='out' ? 'Ø¥Ù„Ù‰: '+l.toName : 'Ù…Ù†: '+l.fromName}</span>
                <span class="${l.type=='out' ? 'out' : 'in'}">${l.type=='out'?'-':'+'}${l.amount}</span>
            </div>
        `).join('');
    }

    function logout() { auth.signOut().then(() => location.reload()); }
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    auth.onAuthStateChanged(user => { if(user) handleAuth(user); else document.getElementById('login-screen').style.display='block'; });
</script>

</body>
</html>
