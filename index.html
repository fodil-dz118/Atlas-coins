<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Coins | السيرفر الرسمي</title>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // إعدادات Firebase الخاصة بمشروعك (لا تغيرها)
      const firebaseConfig = {
        apiKey: "AIzaSyCW-I3Bey1kiNX352IkjyKKYC2hGG4O_UI",
        authDomain: "atlas-coins-23e74.firebaseapp.com",
        projectId: "atlas-coins-23e74",
        storageBucket: "atlas-coins-23e74.firebasestorage.app",
        messagingSenderId: "206077037649",
        appId: "1:206077037649:web:6193349de12520c8cb7c70",
        measurementId: "G-DEP7CD0MG2"
      };

      // تهيئة الخدمات
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      // وظيفة تسجيل الدخول (تم تحسينها للجوال)
      window.loginWithGoogle = async () => {
        try {
          await signInWithRedirect(auth, provider);
        } catch (error) {
          alert("حدث خطأ أثناء محاولة الاتصال بجوجل: " + error.message);
        }
      };

      // مراقبة حالة المستخدم ومعالجة النتيجة بعد العودة من جوجل
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);

            if (snap.exists()) {
              renderDashboard(snap.data());
            } else {
              // مستخدم جديد: إنشاء ID فريد من 9 أرقام
              const rawID = Math.floor(100000000 + Math.random() * 900000000).toString();
              const formattedID = rawID.replace(/(\d{3})(\d{3})(\d{3})/, "$1-$2-$3");
              
              const userData = {
                uid: user.uid,
                name: user.displayName || "مستخدم جديد",
                photo: user.photoURL || "",
                atlasID: formattedID,
                balance: 1000,
                history: []
              };
              
              await setDoc(userRef, userData);
              renderDashboard(userData);
            }
          } catch (e) {
            alert("خطأ في جلب بيانات المستخدم: " + e.message);
          }
        }
      });

      // وظيفة البحث عن المستخدمين بـ ID
      window.searchUser = async () => {
        const idInput = document.getElementById('search-id').value.trim();
        if (!idInput) return alert("يرجى إدخال الـ ID");

        try {
          const q = query(collection(db, "users"), where("atlasID", "==", idInput));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const target = querySnapshot.docs[0].data();
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('res-name').innerText = target.name;
            document.getElementById('res-img').src = target.photo || 'Atlas.png';
            window.targetUser = target;
          } else {
            alert("لم يتم العثور على مستخدم بهذا الـ ID");
          }
        } catch (e) {
          alert("خطأ في البحث: " + e.message);
        }
      };

      // وظيفة إرسال العملات (الحد الأدنى 700)
      window.sendCoins = async () => {
        const amount = parseInt(document.getElementById('amount').value);
        if (!amount || amount < 700) return alert("أدنى حد للتحويل هو 700 عملة");

        try {
          const myRef = doc(db, "users", auth.currentUser.uid);
          const mySnap = await getDoc(myRef);
          const myBalance = mySnap.data().balance;

          if (myBalance < amount) return alert("رصيدك غير كافٍ");

          // خصم من المرسل
          await updateDoc(myRef, {
            balance: myBalance - amount,
            history: arrayUnion({ type: 'sent', name: window.targetUser.name, amount: amount, date: new Date().toLocaleDateString() })
          });

          // إضافة للمستلم
          const targetRef = doc(db, "users", window.targetUser.uid);
          await updateDoc(targetRef, {
            balance: window.targetUser.balance + amount,
            history: arrayUnion({ type: 'received', name: mySnap.data().name, amount: amount, date: new Date().toLocaleDateString() })
          });

          alert("تم التحويل بنجاح!");
          location.reload();
        } catch (e) {
          alert("فشلت عملية التحويل: " + e.message);
        }
      };

      function renderDashboard(data) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-dashboard').style.display = 'block';
        document.getElementById('u-name').innerText = data.name;
        document.getElementById('u-id').innerText = "ID: " + data.atlasID;
        document.getElementById('u-balance').innerText = data.balance.toLocaleString();
        document.getElementById('u-avatar').src = data.photo || 'Atlas.png';
        
        const logContainer = document.getElementById('log-list');
        logContainer.innerHTML = data.history.reverse().map(h => `
          <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333">
            <span>${h.type === 'sent' ? 'إلى: ' : 'من: '}${h.name}</span>
            <span style="color:${h.type === 'sent' ? '#ff4d4d' : '#4dff88'}">${h.type === 'sent' ? '-' : '+'}${h.amount}</span>
          </div>
        `).join('');
      }
    </script>

    <style>
        :root { --gold: #ffcc00; --dark: #050a18; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; text-align: center; direction: rtl; margin: 0; padding: 15px; }
        .card { background: rgba(255,255,255,0.07); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .btn { background: var(--gold); color: black; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn:active { transform: scale(0.98); }
        input { background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; width: 90%; margin: 10px 0; text-align: center; }
        .logo { width: 120px; filter: drop-shadow(0 0 10px var(--gold)); margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <br><br>
        <img src="Atlas.png" class="logo" alt="Atlas Logo">
        <h1>ATLAS COINS</h1>
        <p style="color: #888;">سجل دخولك لفتح محفظتك الرقمية</p>
        <button class="btn" style="width: auto;" onclick="loginWithGoogle()">الدخول عبر Google</button>
    </div>

    <div id="main-dashboard" style="display:none">
        <div class="card">
            <img id="u-avatar" width="80" style="border-radius: 50%; border: 2px solid var(--gold);">
            <h2 id="u-name" style="margin: 10px 0;"></h2>
            <div id="u-id" style="color: var(--gold); font-family: monospace; font-size: 1.2rem;"></div>
            <h1 style="font-size: 3rem; margin: 15px 0;">
                <span id="u-balance"></span> 
                <img src="Atlas coins.png" width="30" style="vertical-align: middle;">
            </h1>
        </div>

        <div class="card">
            <h4 style="text-align: right; margin-top: 0;">تحويل عملات</h4>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="search-id" placeholder="ID المستلم (000-000-000)" style="margin: 0; flex: 1;">
                <button class="btn" style="width: auto;" onclick="searchUser()">بحث</button>
            </div>
            
            <div id="result-box" style="display:none; margin-top: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px;">
                <img id="res-img" width="40" style="border-radius: 50%;">
                <p id="res-name" style="font-weight: bold;"></p>
                <input type="number" id="amount" placeholder="المبلغ (أدنى حد 700)">
                <button class="btn" onclick="sendCoins()">تأكيد التحويل</button>
            </div>
        </div>

        <div class="card" style="text-align: right;">
            <h4>سجل التحويلات</h4>
            <div id="log-list"></div>
        </div>
    </div>

</body>
</html>
