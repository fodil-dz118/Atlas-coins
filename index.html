<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Coins | السيرفر الرسمي</title>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // إعدادات السيرفر الخاصة بك (بدون تغيير)
      const firebaseConfig = {
        apiKey: "AIzaSyCW-I3Bey1kiNX352IKjyKKYC2hGG4O_UI",
        authDomain: "atlas-coins-23e74.firebaseapp.com",
        projectId: "atlas-coins-23e74",
        storageBucket: "atlas-coins-23e74.firebasestorage.app",
        messagingSenderId: "206077037649",
        appId: "1:206077037649:web:6193349de12520c8cb7c70",
        measurementId: "G-DEP7CD0MG2"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      window.loginWithGoogle = async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const userRef = doc(db, "users", result.user.uid);
          const docSnap = await getDoc(userRef);

          if (docSnap.exists()) { renderDashboard(docSnap.data()); } 
          else { document.getElementById('login-screen').style.display = 'none'; document.getElementById('setup-screen').style.display = 'block'; }
        } catch (e) { alert("خطأ في الاتصال بالسيرفر"); }
      };

      window.completeSetup = async () => {
        const user = auth.currentUser;
        const name = document.getElementById('full-name').value || "مستخدم أطلس";
        // توليد ID من 9 أرقام
        const newID = Math.floor(100000000 + Math.random() * 900000000).toString().replace(/(\d{3})(\d{3})(\d{3})/, "$1-$2-$3");

        const userData = {
          uid: user.uid,
          name: name,
          photo: user.photoURL || "",
          atlasID: newID,
          balance: 2000, // رصيد بداية
          history: []
        };

        await setDoc(doc(db, "users", user.uid), userData);
        renderDashboard(userData);
      };

      window.searchUser = async () => {
        const id = document.getElementById('search-id').value.trim();
        if (id.length < 9) return alert("أدخل ID صحيح مكون من 9 أرقام");
        
        const q = query(collection(db, "users"), where("atlasID", "==", id));
        const snap = await getDocs(q);

        if (!snap.empty) {
          const target = snap.docs[0].data();
          document.getElementById('result-box').style.display = 'block';
          document.getElementById('res-name').innerText = target.name;
          document.getElementById('res-img').src = target.photo || 'Atlas.png';
          window.targetUser = target;
        } else { alert("عذراً، هذا الـ ID غير مسجل في النظام"); }
      };

      window.sendCoins = async () => {
        const amt = parseInt(document.getElementById('amount').value);
        
        // شرط الحد الأدنى للتحويل (700 عملة)
        if (amt < 700) {
            alert("عذراً، أقل مبلغ للتحويل هو 700 عملة");
            return;
        }

        const user = auth.currentUser;
        const myRef = doc(db, "users", user.uid);
        const myData = (await getDoc(myRef)).data();

        if (myData.balance < amt) return alert("رصيدك الحالي لا يكفي لإتمام العملية");

        // تحديث الخصم للمرسل
        await updateDoc(myRef, {
          balance: myData.balance - amt,
          history: arrayUnion({ type: 'sent', name: window.targetUser.name, amount: amt })
        });

        // تحديث الإضافة للمستلم
        const hisRef = doc(db, "users", window.targetUser.uid);
        await updateDoc(hisRef, {
          balance: window.targetUser.balance + amt,
          history: arrayUnion({ type: 'received', name: myData.name, amount: amt })
        });

        alert("تم تحويل " + amt + " عملة بنجاح!");
        location.reload();
      };

      function renderDashboard(data) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('main-dashboard').style.display = 'block';
        document.getElementById('u-name').innerText = data.name;
        document.getElementById('u-id').innerText = "ID: " + data.atlasID;
        document.getElementById('u-balance').innerText = data.balance.toLocaleString();
        document.getElementById('u-avatar').src = data.photo || 'Atlas.png';
        
        const logHtml = data.history.reverse().map(h => `
          <div class="log-item">
            <span>${h.type === 'sent' ? 'إلى: ' : 'من: '}${h.name}</span>
            <span style="color:${h.type === 'sent' ? '#ff4444' : '#00ff88'}">${h.type === 'sent' ? '-' : '+'}${h.amount}</span>
          </div>
        `).join('');
        document.getElementById('log-list').innerHTML = logHtml;
      }
    </script>

    <style>
        :root { --gold: #ffcc00; --bg: #050a18; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; direction: rtl; margin: 0; padding: 20px; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .btn { background: var(--gold); color: #000; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn:active { transform: scale(0.95); }
        input { padding: 12px; border-radius: 12px; border: 1px solid #333; background: rgba(255,255,255,0.1); color: white; margin: 10px 0; width: 90%; text-align: center; }
        .log-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .coin-img { width: 25px; vertical-align: middle; margin-right: 5px; }
    </style>
</head>
<body>
    <div id="login-screen">
        <br><br><img src="Atlas.png" width="150" style="filter: drop-shadow(0 0 10px var(--gold))"><br>
        <h1 style="color: var(--gold)">ATLAS COINS</h1>
        <p>مرحباً بك في مستقبل التحويلات الرقمية</p>
        <button class="btn" style="width: auto" onclick="loginWithGoogle()">تسجيل الدخول عبر Google</button>
    </div>

    <div id="setup-screen" style="display:none">
        <div class="card">
            <h3>إعداد المحفظة الجديدة</h3>
            <input type="text" id="full-name" placeholder="ادخل اسمك المستعار">
            <button class="btn" onclick="completeSetup()">تفعيل الحساب</button>
        </div>
    </div>

    <div id="main-dashboard" style="display:none">
        <div class="card">
            <img id="u-avatar" width="80" style="border-radius:50%; border: 2px solid var(--gold)">
            <h2 id="u-name" style="margin: 10px 0"></h2>
            <div id="u-id" style="background: rgba(0,0,0,0.3); display: inline-block; padding: 5px 15px; border-radius: 10px; color: var(--gold); font-family: monospace;"></div>
            <h1 style="font-size: 3rem; margin: 20px 0;">
                <span id="u-balance"></span> 
                <img src="Atlas coins.png" class="coin-img">
            </h1>
        </div>

        <div class="card">
            <h4 style="text-align: right; color: var(--gold); margin-top: 0;">تحويل عملات (أدنى حد 700)</h4>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="search-id" placeholder="ID المستلم (9 أرقام)" style="margin: 0; flex: 1;">
                <button class="btn" style="width: auto;" onclick="searchUser()">بحث</button>
            </div>
            
            <div id="result-box" style="display:none; margin-top:20px; padding: 15px; background: rgba(255,204,0,0.1); border-radius: 15px;">
                <img id="res-img" width="50" style="border-radius:50%">
                <p id="res-name" style="font-weight: bold;"></p>
                <input type="number" id="amount" placeholder="المبلغ (700 أو أكثر)">
                <button class="btn" onclick="sendCoins()">تأكيد التحويل الآن</button>
            </div>
        </div>

        <div class="card" style="text-align: right">
            <h4 style="color: var(--gold)">آخر التحويلات</h4>
            <div id="log-list"></div>
        </div>
    </div>
</body>
</html>
